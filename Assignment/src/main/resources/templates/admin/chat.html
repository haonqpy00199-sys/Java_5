<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>SkyShop - Trung Tâm Hỗ Trợ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        .chat-container { height: calc(100vh - 100px); background: white; border-radius: 15px; overflow: hidden; }
        .user-list { border-right: 1px solid #eee; overflow-y: auto; background: #f8fafc; }
        .user-item { cursor: pointer; transition: 0.2s; border-bottom: 1px solid #f1f5f9; }
        .user-item:hover, .user-item.active { background: #e0f2fe; border-left: 4px solid #00a8e8; }
        .chat-main { display: flex; flex-direction: column; background: #fff; }
        .chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; background: #f1f5f9; }
        .msg { margin-bottom: 15px; max-width: 70%; padding: 10px 15px; border-radius: 15px; }
        .msg-inbox { background: white; align-self: flex-start; color: #334155; }
        .msg-outbox { background: #00a8e8; color: white; align-self: flex-end; margin-left: auto; }
    </style>
</head>
<body class="bg-light">

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold text-dark"><i class="fa-solid fa-headset me-2 text-info"></i>SkyShop Support Center</h4>
        <a th:href="@{/admin/product/index}" class="btn btn-outline-secondary btn-sm rounded-pill px-3">Quay lại Quản trị</a>
    </div>

    <div class="row chat-container shadow-sm">
        <div class="col-md-4 p-0 user-list d-none d-md-block" th:if="${session.user != null and session.user.admin}">
            <div class="p-3 bg-white border-bottom fw-bold">Cuộc trò chuyện gần đây</div>
            <div id="contact-list">
                <div class="user-item p-3 d-flex align-items-center active" onclick="selectUser('User_889')">
                    <img src="https://ui-avatars.com/api/?name=Hao&background=random" class="rounded-circle me-3" width="45">
                    <div>
                        <div class="fw-bold small">Quốc Hào</div>
                        <div class="text-muted small">Đang hoạt động 13 phút trước</div>
                    </div>
                </div>
            </div>
        </div>

        <div th:class="${session.user != null and session.user.admin} ? 'col-md-8 chat-main p-0' : 'col-md-12 chat-main p-0'">
            <div class="chat-header p-3 border-bottom d-flex align-items-center bg-white">
                <img src="https://ui-avatars.com/api/?name=Support&background=00a8e8&color=fff" class="rounded-circle me-3" width="40">
                <span class="fw-bold" id="chat-with">Đang chat với: SkyShop Support</span>
            </div>

            <div class="chat-messages d-flex flex-column" id="chat-area">
            </div>

            <div class="chat-footer p-3 border-top bg-white d-flex gap-2">
                <input type="text" id="chat-input" class="form-control border-0 bg-light shadow-none" placeholder="Nhập tin nhắn...">
                <button class="btn btn-primary px-4 rounded-pill" onclick="sendPrivate()">Gửi</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script th:inline="javascript">
    let stompClient = null;
    let selectedUser = "admin"; // Mặc định khách hàng gửi cho admin
    const currentUsername = [[${session.user != null ? session.user.username : 'Guest_' + #numbers.formatInteger(#math.random()*1000, 0)}]];

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function () {
            stompClient.subscribe('/user/queue/messages', function (msg) {
                render(JSON.parse(msg.body));
            });
        });
    }

    function sendPrivate() {
        const input = document.getElementById('chat-input');
        if (input.value.trim() && stompClient) {
            const msg = { sender: currentUsername, to: selectedUser, content: input.value };
            stompClient.send("/app/chat.private", {}, JSON.stringify(msg));
            render(msg); // Hiện tin nhắn của mình
            input.value = "";
        }
    }

    function render(msg) {
        const area = document.getElementById('chat-area');
        const div = document.createElement('div');
        div.className = `msg ${msg.sender === currentUsername ? 'msg-outbox' : 'msg-inbox'} shadow-sm`;
        div.innerHTML = `<small class="d-block fw-bold" style="font-size:0.6rem">${msg.sender}</small>${msg.content}`;
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    function selectUser(username) {
        selectedUser = username;
        document.getElementById('chat-with').innerText = "Đang chat với: " + username;
        document.getElementById('chat-area').innerHTML = ""; // Xóa màn hình để chat mới
    }

    window.onload = connect;
</script>
</body>
</html>